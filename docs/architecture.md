# Архитектура проекта KITSU

> ⚠️ **КРИТИЧЕСКИ ВАЖНО**
> Этот файл является **архитектурной спецификацией для AI-агента (Copilot / Agent Mode)**.
>
> ❌ Запрещено интерпретировать требования свободно
> ❌ Запрещено упрощать архитектуру
> ❌ Запрещено объединять слои «для удобства»
>
> Любое отклонение от данного документа считается **архитектурной ошибкой**.

---

## 1. Архитектурная роль документа

`architecture.md` определяет:

* слои системы
* зоны ответственности
* направления зависимостей
* запреты на прямые взаимодействия
* требования к масштабированию и безопасности

Этот файл является **Source of Truth** для всей кодовой базы.

---

## 2. Общая схема системы

```
[PWA / Browser]
        ↓ HTTPS
[Frontend: Next.js]
        ↓ REST API (JSON)
[Backend: FastAPI]
        ↓
[Domain Services]
        ↓
[Parsers / Providers]
        ↓
[External APIs]
  ├─ Kodik API
  └─ Shikimori API
```

---

## 3. Архитектурные слои (СТРОГО)

### 3.1 Frontend Layer

**Назначение:**

* пользовательский интерфейс
* плеер
* взаимодействие с backend

**Разрешено:**

* REST-запросы к backend
* работа с UI-состоянием
* воспроизведение HLS через HLS.js

**Запрещено:**

* любые прямые запросы к Kodik / Shikimori
* хранение API-ключей
* бизнес-логика

---

### 3.2 API Layer (Backend)

**Назначение:**

* единая точка входа
* валидация данных
* авторизация
* rate limiting

**Ответственность:**

* принимать запросы frontend
* возвращать нормализованные данные

**Запрещено:**

* отдавать данные провайдеров без нормализации
* проксировать видео-потоки

---

### 3.3 Domain Layer

**Назначение:**

* бизнес-логика
* агрегирование данных
* правила платформы

**Примеры сервисов:**

* AnimeService
* EpisodeService
* PlayerService

**Правила:**

* не знает о HTTP
* не знает о UI
* не знает о конкретных провайдерах

---

### 3.4 Parsers / Providers Layer

**Назначение:**

* взаимодействие с внешними API

**Каждый провайдер:**

* изолирован
* реализует единый интерфейс
* может быть отключён без влияния на систему

**Запрещено:**

* бизнес-логика
* агрегация данных

---

## 4. Направление зависимостей (КРИТИЧНО)

```
Frontend → API → Domain → Providers
```

❌ Обратные зависимости запрещены.

---

## 5. Контракты между слоями

### 5.1 Frontend → Backend

* JSON
* строгая схема
* ошибки стандартизированы

Пример:

```json
{
  "error": {
    "code": "ANIME_NOT_FOUND",
    "message": "Anime not found"
  }
}
```

---

### 5.2 Domain → Providers

* async интерфейсы
* таймауты обязательны
* retry с backoff

---

## 6. Безопасность (НЕОБСУЖДАЕМО)

* все ключи в ENV
* логирование без чувствительных данных
* защита от SSRF
* защита от XSS
* защита от rate abuse

---

## 7. Масштабирование

Проект должен поддерживать:

* добавление новых провайдеров
* рост нагрузки
* горизонтальное масштабирование backend

Запрещено:

* жёсткие зависимости
* singleton-провайдеры

---

## 8. Ошибки и отказоустойчивость

* каждый слой обрабатывает свои ошибки
* провайдер может быть недоступен
* система продолжает работу

---

## 9. Требования к коду (для AI)

* читаемость > краткость
* явные типы
* отсутствие магии
* детерминированность

---

## 10. Статус документа

Этот файл:

* обязателен к соблюдению
* изменяется только при архитектурных решениях
* используется AI-агентом как инструкция
