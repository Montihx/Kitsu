# Player — спецификация видеоплеера KITSU

> ⚠️ **КРИТИЧЕСКИ ВАЖНО**
> Этот документ определяет **полное поведение видеоплеера** в KITSU.
> Используется **Frontend**, **Backend** и **AI Copilot / Agent**.
>
> ❌ Упрощения UX запрещены
> ❌ Обход HLS.js запрещён
> ❌ Игнорирование edge‑cases запрещено

---

## 1. Роль плеера в системе

Player — это:

* единственная точка воспроизведения видео
* связующее звено между UX и backend API
* компонент повышенного риска (HLS, сеть, мобильные устройства)

Player **НЕ**:

* iframe
* встроенный плеер провайдера
* proxy для видео

---

## 2. Технологический стек

Frontend:

* HTML5 video
* HLS.js (обязательно)
* React (Next.js App Router)

Backend:

* API `/streams`
* API `/player/progress`

---

## 3. Источник данных

Плеер получает данные **ТОЛЬКО** от backend:

1. список доступных переводов
2. список эпизодов
3. HLS (.m3u8) по выбранному переводу

❌ Прямые ссылки от Kodik запрещены

---

## 4. Инициализация плеера

Алгоритм:

1. запрос эпизода
2. запрос доступных переводов
3. запрос HLS stream
4. инициализация HLS.js
5. установка последнего времени просмотра

Все шаги обязательны.

---

## 5. Работа с HLS.js

Обязательные требования:

* `lowLatencyMode = true`
* обработка `ERROR`, `MANIFEST_PARSED`, `FRAG_LOADED`
* fallback при ошибке сегмента

❌ Использование native HLS без HLS.js запрещено

---

## 6. Переключение качества

* качества извлекаются из master playlist
* пользователь может выбрать вручную
* auto — по умолчанию

Переключение **без перезагрузки страницы**.

---

## 7. Переключение перевода

* при смене перевода:

  * сохраняется текущий time
  * загружается новый HLS
  * продолжается воспроизведение

---

## 8. Resume (продолжить просмотр)

* позиция сохраняется каждые 10 секунд

* сохраняется:

  * episodeId
  * time

* восстановление при повторном открытии

---

## 9. Ошибки и UX

Обязательные состояния:

* загрузка
* ошибка сети
* поток недоступен
* повторная попытка

Пользователь **всегда** видит понятное сообщение.

---

## 10. Mobile / Desktop

* адаптивный UI
* поддержка touch
* корректная работа fullscreen

---

## 11. Безопасность

* URL HLS валидируются backend
* токены не логируются
* защита от XSS через video attributes

---

## 12. Тестирование

* unit tests (logic)
* e2e tests (playback)
* имитация плохой сети

---

## 13. Статус документа

* обязателен
* canonical
* используется Copilot как инструкция
