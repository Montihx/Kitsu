# Backend Structure — разбиение на пакеты и модули (KITSU)

> ⚠️ **КАНОНИЧЕСКИЙ ДОКУМЕНТ**
> Этот файл определяет **физическую и логическую структуру backend-кода** проекта KITSU.
> Используется:
>
> * Backend разработкой
> * Архитектурными решениями
> * **AI Copilot / Agent**
>
> ❌ Отклонения от структуры запрещены
> ❌ Смешивание слоёв запрещено

---

## 1. Зачем нужен этот файл

Без зафиксированной структуры:

* AI-агент смешивает Domain, API и Providers
* появляются циклические зависимости
* код становится немасштабируемым

`backend-structure.md` решает это, задавая **единственно допустимую форму проекта**.

---

## 2. Корневая структура backend

```
backend/
 ├─ app/
 │   ├─ main.py
 │   ├─ config/
 │   ├─ api/
 │   ├─ domain/
 │   ├─ providers/
 │   ├─ infrastructure/
 │   └─ common/
 └─ tests/
```

`backend/` — изолированный сервис, не знает о frontend.

---

## 3. app/main.py

**Назначение:**

* точка входа FastAPI

Разрешено:

* инициализация приложения
* подключение роутеров
* middleware

❌ Запрещено:

* бизнес-логика
* обращения к провайдерам

---

## 4. app/config/

```
config/
 ├─ settings.py
 └─ logging.py
```

### settings.py

* чтение ENV
* валидация конфигурации

### logging.py

* конфигурация логирования
* маскирование чувствительных данных

---

## 5. app/api/

```
api/
 └─ v1/
     ├─ anime.py
     ├─ episodes.py
     └─ player.py
```

**Назначение:**

* HTTP слой

Разрешено:

* принимать запросы
* вызывать Domain Services
* возвращать DTO

❌ Запрещено:

* логика агрегации
* работа с провайдерами напрямую

---

## 6. app/domain/

```
domain/
 ├─ models/
 ├─ services/
 └─ interfaces/
```

### models/

* чистые доменные модели
* без зависимостей от FastAPI

### services/

* бизнес-логика
* агрегация данных

### interfaces/

* абстракции провайдеров

---

## 7. app/providers/

```
providers/
 ├─ kodik/
 └─ shikimori/
```

Каждый провайдер:

* client.py — HTTP взаимодействие
* mapper.py — нормализация

❌ Запрещено:

* бизнес-логика

---

## 8. app/infrastructure/

```
infrastructure/
 ├─ db/
 ├─ cache/
 └─ http/
```

**Назначение:**

* техническая реализация

Примеры:

* PostgreSQL
* Redis
* HTTP clients

---

## 9. app/common/

```
common/
 ├─ errors.py
 ├─ schemas.py
 └─ utils.py
```

Используется всеми слоями.

---

## 10. tests/

* unit tests
* integration tests
* mock providers

---

## 11. Правила зависимостей (КРИТИЧНО)

```
api → domain → providers
```

❌ Обратные зависимости запрещены.

---

## 12. Требования для AI-агента

* создавать файлы строго по этой структуре
* не объединять папки
* не упрощать

---

## 13. Статус документа

* обязателен
* архитектурный
* source of truth
